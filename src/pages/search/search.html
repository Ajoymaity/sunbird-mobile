<ion-header>
  <ion-navbar>
    <ion-input type="search" *ngIf="!dialCode" #searchInput dir="{{commonUtilService.getAppDirection()}}"
               (keyup.enter)="handleSearch()"
               (ngModelChange)="searchContentResult = undefined; filterIcon = false; isEmptyResult = false"
               [(ngModel)]="searchKeywords" [placeholder]="'Search'"></ion-input>
    <ion-buttons end *ngIf="!dialCode">
      <button (click)="searchKeywords = ''; searchContentResult = undefined; filterIcon = false; isEmptyResult = false"
              *ngIf="searchKeywords" ion-button>
        <img class="tool-icon" src="./assets/imgs/ic_action_close.png">
      </button>
      <button ion-button (click)="showFilter()" *ngIf="filterIcon">
        <img class="tool-icon" src="./assets/imgs/ic_filter.png">
      </button>
    </ion-buttons>
  </ion-navbar>
</ion-header>
<ion-content #contentView>
  <ng-container *ngIf="searchHistory$ && (searchHistory$ | async) as searchHistory">
    <ng-container *ngIf="!(
          showLoader ||
          isEmptyResult ||
          displayDialCodeResult ||
          (dialCodeContentResult && dialCodeContentResult.length) ||
          (searchContentResult && searchContentResult.length) ||
          (!showLoader && showEmptyMessage)
    )">
      <ng-container *ngIf="!searchHistory.length && !searchKeywords">
        <div class="sb-no-search-history">
      <span>
        {{'SEARCH_TO_FIND_CONTENT' | translate: {'%s': appName} }}
      </span>
        </div>
      </ng-container>

      <ng-container *ngIf="searchHistory.length && searchKeywords">
        <div class="sb-search-history-entry sb-search-header-meta row">
          <div class="col-auto invisible">
            <img src="assets/imgs/icon_recent.svg">
          </div>
          <div class="col">
            {{'SEE_ALL_RESULTS_FOR' | translate: {'%s': searchKeywords} }}
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="searchHistory.length">
        <div (tap)="searchKeywords = searchEntry.query; handleSearch()" *ngFor="let searchEntry of searchHistory"
             class="sb-search-history-entry row">
          <div class="col-auto">
            <img src="assets/imgs/icon_recent.svg">
          </div>
          <div class="col">
            {{searchEntry.query}}
          </div>
          <div class="col-auto">
            <img src="assets/imgs/icon_recent_back.svg">
          </div>
        </div>
      </ng-container>
    </ng-container>
  </ng-container>

  <ng-container *ngIf="isEmptyResult">
    <div class="sb-no-search-history">
      <span>
        {{ 'EMPTY_SEARCH_RESULTS' | translate }}
      </span>
    </div>
  </ng-container>

  <div class="spinner-container" *ngIf="showLoader">
    <ion-spinner padding class="loader"></ion-spinner>
  </div>
  <!-- Testing here  -->
  <ion-list no-lines *ngIf="displayDialCodeResult" class="collection-list">
    <div *ngFor="let resultlist of displayDialCodeResult">

      <!-- Course -->
      <div
        *ngIf="resultlist && resultlist.isCourse && resultlist.dialCodeContentResult && resultlist.dialCodeContentResult.length">
        <div class="sb-textbook-container">
          <div class="sb-textbook-items">
            <div class="sb-textbook-title-container">
              <span class="textbook-icon">
                <ion-icon ios="ios-albums" md="md-albums"></ion-icon>
              </span>
              <span class="textbook-title">
                Courses
              </span>
            </div>
            <!-- Card style -->
            <div class="sb-card-container sb-card-textbook-container">
                <div class="sb-card" *ngFor="let content of resultlist.dialCodeContentResult; let i = index; let last = last" (click)="openContent(undefined, content,index)">
                  <div class="img-container" style="display: flex;
                  justify-content: center;
                  flex-direction: column;
                  text-align: center;">
                    <img src="{{ content?.courseLogoUrl || content?.appIcon || defaultAppIcon }}">
                  </div>
                  <div class="sb-card-details">
                    <div class="title">{{ (content.name && content.name.length > 30) ? (content.name | slice:0:30) + '...' : (content.name) }} </div>
                    <div class="grade_ellipsis">
                      <span class="info subject">{{ content.size | fileSize: 0}}</span>
                    </div>
                  </div>
                </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="resultlist && !resultlist.isCourse">
        <h4 class="dial-section-header">{{resultlist.name}}</h4>

        <!-- Collection List -->
        <div ion-item no-margin *ngFor="let result of resultlist.dialCodeResult" no-padding>
          <div no-lines class="collection-header" margin-start>
            <div class="collection-name">
              <span>{{'FROM' | translate}} </span>{{ result.name }}</div>
            <button ion-button clear no-padding class="view-collection" (click)="openCollection(result)">
              {{'VIEW' | translate}} {{ result.contentType }} &nbsp;
              <ion-icon ios="ios-arrow-forward" md="ios-arrow-forward"></ion-icon>
            </button>
          </div>
          <div *ngIf="result && result.content && result.content.length">
            <ion-list no-padding *ngFor="let content of result.content let i = index; let last = last"
                      class="content-list">
              <ion-item (click)="openContent(result, content,index)">
                <ion-avatar item-start>
                  <img src="{{ defaultAppIcon }}" width="24px" height="24px">
                </ion-avatar>
                <h3>
                  {{ (content.name && content.name.length > 30) ? (content.name | slice:0:30) + '...' : (content.name) }}
                </h3>
                <p>
                  <span>{{ content.contentType }}</span>
                  <span *ngIf="content.size"> • {{ content.size | fileSize: 0}}</span>
                </p>
              </ion-item>
              <div *ngIf="!last" class="inner-divider"></div>
            </ion-list>
          </div>
          <div class="divider"></div>
        </div>

        <!-- Content List -->
        <ion-list no-lines *ngIf="resultlist.dialCodeContentResult && resultlist.dialCodeContentResult.length">
          <ion-list *ngFor="let content of resultlist.dialCodeContentResult; let i = index; let last = last"
                    class="content-list">
            <ion-item padding-start (click)="openContent(undefined, content,index)">
              <ion-avatar item-start>
                <img src="{{ defaultAppIcon }}" width="24px" height="24px">
              </ion-avatar>
              <h3>
                {{ (content.name && content.name.length > 30) ? (content.name | slice:0:30) + '...' : (content.name) }}
              </h3>
              <p>
                <span>{{ content.contentType }}</span>
                <span *ngIf="content.size"> • {{ content.size | fileSize: 0}}</span>
              </p>
              <p>
                <span *ngIf="content.gradeLevel && content.gradeLevel.length">
                  {{ content?.gradeLevel[0] }}
                </span>
                <span *ngIf="content.subject"> • {{ content?.subject}}</span>
              </p>
            </ion-item>
            <div *ngIf="!last" class="inner-divider"></div>
          </ion-list>
        </ion-list>
      </div>
    </div>
  </ion-list>

  <!-- Testing here -->

  <div *ngIf="dialCodeContentResult && dialCodeContentResult.length">
    <div class="sb-card-container sb-card-textbook-container">
      <textbook-card class="tb-border-btm" *ngFor="let content of dialCodeContentResult; let i = index; let last = last"
                     (click)="openContent(content, content,i)" [content]="content"
                     [layoutName]='search'></textbook-card>
    </div>
  </div>


  <div *ngIf="searchContentResult && searchContentResult.length">
    <div class="sb-search-history-entry sb-search-header-meta row">
      <div class="col">
        {{'SHOWING_RESULTS_FOR' | translate: {'%count': searchContentResult.length, '%query': searchKeywords} }}
      </div>
    </div>
    <div class="sb-card-container sb-card-textbook-container">
      <textbook-card class="tb-border-btm" *ngFor="let content of searchContentResult; let i = index; let last = last"
        (click)="openContent(undefined, content,i)" [content]="content" [layoutName]="search"></textbook-card>
    </div>
  </div>
  <div class="empty-search-result" *ngIf="!showLoader && showEmptyMessage" text-center padding-top>
    {{ 'EMPTY_SEARCH_RESULTS' | translate }}
  </div>
</ion-content>

<ion-backdrop class="loading-backdrop" *ngIf="showLoading" text-center>
  <div class="backdrop-container">
    <ion-label>{{ loadingDisplayText }}</ion-label>
    <pb-horizontal [progress]="downloadProgress" isOnBoardCard="false"></pb-horizontal>
  </div>

  <div class="backdrop-footer">
    <button ion-button small class="cancel-btn" (click)="cancelDownload()">{{'CANCEL' | translate}}</button>
  </div>
</ion-backdrop>
